<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Room</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f5f5f5;
    }
    #join-container {
      max-width: 500px;
      padding: 20px;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    #room-link {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      word-wrap: break-word;
    }
    @media (max-width: 576px) {
        body {
            display: block;
            padding-left: 10px;
        }
    }
    #legal-note {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
    }
    #qrcode {
      margin-top: 20px;
    }
    #qrcode > img {
      margin: 0 auto;
    }
    .modal {
      max-height: 90%;
    }
    #share-room-input {
      min-height: 100px;
    }
    .warning-text {
      color: hwb(56 17% 21% / 0.764);
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="join-container">
    <h4 class="center-align">Join Keet Room: <br/><span id="room-title"></span></h4>
    <div class="center-align" id="qrcode"></div>
    <div class="center-align" id="room-link"></div><br/>
    <div class="center-align">
        <a id="join-link" class="cyan accent-4 waves-effect waves-light btn" target="_blank" href="#">Join room with Keet</a>
    </div>
    <br/>
    <div class="center-align">
      <div id="legal-note">
        <p><a href="#" id="share-room-link">‚ûï Create a keetlink?</a></p>
        <text>if haven't installed üê¶, </text><a id="download-link" href="#">Get Keet</a>
        <p class="warning-text">‚ö†Ô∏è This is not an official service from Keet.io, but you can verify the 
          <a href="https://github.com/gasolin/keetlink/blob/main/index.html" target="_blank">source</a>.</p>
      </div>
    </div>
  </div>

  <!-- Modal Structure -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Get Keet</h4>
      <p>Please download the Keet app first to join the room.</p>
      <div id="download-options"></div>
    </div>
  </div>

  <div id="share-room-modal" class="modal">
    <div class="modal-content">
      <h4>Keet invite convertor</h4>
      <div class="input-field">
        <textarea id="share-room-input" class="materialize-textarea"></textarea>
        <label for="share-room-input">Paste your room invite here</label>
      </div>

      <div class="center-align">
        <button id="convert-btn" class="cyan accent-4 waves-effect waves-light btn">Convert to Shareable keetlink</button>
      </div>

      <div id="converted-link" class="hide">
        <h6>Your shareable keetlink:</h6>
        <div id="converted-link-text" class="input-field">
          <input type="text" id="share-link-output" readonly>
        </div>
        <button id="copy-link-btn" class="waves-effect waves-light btn">Copy Link</button>
      </div>

      <div class="center-align">
        <p><a href="https://github.com/gasolin/keetlink/tree/main?tab=readme-ov-file#how-i-turn-my-invite-link-to-a-web-link" target="_blank">üìó Guide</a></p>
      </div>
    </div>
  </div>

  <script src="lib/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@2.0.4/dist/qrcode.js"></script>
  <script>
    // If you host elsewhere, define your url here
    var BASE_URL = 'https://gasolin.idv.tw';

    document.addEventListener('DOMContentLoaded', function() {
      // Parse anchor to get key and title
      // Supports 3 formats as documented in README:
      // 1. Basic: #key=[room_key]&title=[room_title]
      // 2. Simple: #{room_key}
      // 3. Simple with title: #{room_key}&title={room_title}
      function parseAnchor(hash) {
        if (!hash) return {};

        // Remove the leading #
        hash = hash.substring(1);
        
        const params = {};
        
        // Check if hash contains '=' (indicates key=value format)
        if (hash.includes('=')) {
          // Format 1 or 3: Contains key=value pairs
          hash.split('&').forEach(pair => {
            const [key, value] = pair.split('=');
            if (key && value) {
              params[key] = decodeURIComponent(value);
            }
          });
        } else {
          // Format 2: Simple format - could be just key or key&title=value
          const parts = hash.split('&');
          
          // First part is always the key
          if (parts[0]) {
            params.key = parts[0];
          }
          
          // Check for title parameter in remaining parts
          for (let i = 1; i < parts.length; i++) {
            if (parts[i].startsWith('title=')) {
              params.title = decodeURIComponent(parts[i].substring(6));
              break;
            }
          }
        }

        return params;
      }

      // Get parameters from anchor
      const anchorParams = parseAnchor(window.location.hash);

      // Use anchor key if available, then default
      var key = anchorParams.key || 'yry7g7wa7bmrjd1xxr7ce64581ij3hozq7589xfgxjrm74kgp34o36pwp46ohw4u1w63o6is6sax6j3swgdi66dmti8p8nfuyypfwewbuy';
      // Use anchor title if available, then default
      // Decode URI component only if title exists
      var title = anchorParams.title ? decodeURIComponent(anchorParams.title) :
                (key ? '' : 'Pear Community');

      var joinLink = 'pear://keet/' + key;

      document.getElementById('room-title').textContent = title;
      document.getElementById('room-link').textContent = joinLink
      document.getElementById('join-link').href = joinLink;

      // Generate QR code using qrcode-generator
      var qr = qrcode(0, 'M');
      qr.addData(joinLink);
      qr.make();
      
      // Create canvas and append to qrcode div
      var canvas = document.createElement('canvas');
      var size = 200;
      var cellSize = Math.floor(size / qr.getModuleCount());
      canvas.width = size;
      canvas.height = size;
      var ctx = canvas.getContext('2d');
      
      // Draw QR code
      for (var row = 0; row < qr.getModuleCount(); row++) {
        for (var col = 0; col < qr.getModuleCount(); col++) {
          ctx.fillStyle = qr.isDark(row, col) ? '#000000' : '#FFFFFF';
          ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
        }
      }
      
      document.getElementById("qrcode").appendChild(canvas);

      // Initialize modals
      var modals = document.querySelectorAll('.modal');
      var modalInstances = M.Modal.init(modals);

      // Share room modal functionality
      var shareRoomLink = document.getElementById('share-room-link');
      var shareRoomModal = document.getElementById('share-room-modal');
      var convertBtn = document.getElementById('convert-btn');
      var copyLinkBtn = document.getElementById('copy-link-btn');
      var shareRoomInput = document.getElementById('share-room-input');
      var convertedLinkDiv = document.getElementById('converted-link');
      var shareLinkOutput = document.getElementById('share-link-output');

      shareRoomLink.addEventListener('click', function(e) {
        e.preventDefault();
        var shareRoomModalInstance = M.Modal.getInstance(shareRoomModal);
        shareRoomModalInstance.open();
      });

      convertBtn.addEventListener('click', function() {
        var input = shareRoomInput.value.trim();
        var pearMatch = input.match(/pear:\/\/keet\/([^,\s]+)/);

        if (pearMatch) {
          var key = pearMatch[1];
          var convertedUrl = `${BASE_URL}/keetlink/#key=${key}`;
          shareLinkOutput.value = convertedUrl;
          convertedLinkDiv.classList.remove('hide');
          M.updateTextFields();
        } else {
          M.toast({html: 'Please enter a valid Keet room link starting with "pear://keet/"'});
        }
      });

      copyLinkBtn.addEventListener('click', function() {
        shareLinkOutput.select();
        document.execCommand('copy');
        M.toast({html: 'Link copied to clipboard!'});
      });

      // Download keet
      var downloadBtn = document.getElementById('download-link');
      checkOS();

      function checkOS() {
        var userAgent = navigator.userAgent || navigator.vendor || window.opera;
        if (!(/windows|macintosh|mac os x|android|iPad|iPhone|iPod/i.test(userAgent))) {
          downloadBtn.innerHTML = '<a href="https://keet.io">Get App from Keet.io</a>';
        }
        if (/windows/i.test(userAgent)) {
          downloadBtn.innerHTML = '<a href="https://static.keet.io/downloads/latest/Keet.msix">Get Keet for Windows</a>';
        } else if (/macintosh|mac os x/i.test(userAgent)) {
          downloadBtn.innerHTML = '<a href="https://static.keet.io/downloads/latest/Keet-Apple-Silicon.dmg">Get Keet for Apple Silicon</a>';
        } else if (/android/i.test(userAgent)) {
          downloadBtn.innerHTML = '<a href="https://play.google.com/store/apps/details?id=io.keet.app">Get Keet from Play Store</a>';
        } else if (/iPad|iPhone|iPod/i.test(userAgent)) {
          downloadBtn.innerHTML = '<a href="https://apps.apple.com/us/app/keet-by-holepunch/id6443880549">Get Keet from App Store</a>';
        } else {
          downloadBtn.innerHTML = '<a href="https://static.keet.io/downloads/latest/Keet-x64.tar.gz">Get Keet for Linux</a>';
        }
      }
    });
  </script>
</body>
</html>
